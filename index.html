<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxograma - Gest√£o de Eventos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --primary-dark: #1a252f;
            --secondary: #e74c3c;
            --accent: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --gray-light: #bdc3c7;
            --white: #ffffff;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            flex: 1;
        }

        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
            text-align: center;
        }

        .logo {
            height: 40px;
            margin-bottom: 0.5rem;
            max-width: 100%;
        }

        h1, h2, h3 {
            color: var(--primary);
            font-weight: 700;
            word-break: break-word;
        }

        h1 {
            font-size: clamp(1.4rem, 4vw, 1.8rem);
            margin-bottom: 0.3rem;
        }

        .subtitle {
            color: var(--gray);
            font-size: clamp(0.9rem, 3vw, 1rem);
        }

        .flowchart {
            position: relative;
            width: 100%;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .step {
            width: 100%;
            max-width: 100%;
            padding: 1rem;
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            margin: 0 auto 1.5rem;
            position: relative;
            transition: var(--transition);
        }

        @media (min-width: 768px) {
            .step {
                max-width: 90%;
                padding: 1.25rem;
            }
        }

        @media (min-width: 992px) {
            .step {
                max-width: 80%;
                padding: 1.5rem;
            }
        }

        .step.editable {
            border: 2px dashed var(--accent);
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .step-icon {
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: 50%;
            background-color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.8rem;
            color: white;
            font-size: 1rem;
        }

        .step-title {
            font-weight: 700;
            color: var(--primary);
            font-size: clamp(1rem, 4vw, 1.2rem);
            word-break: break-word;
            flex: 1;
            min-width: 200px;
        }

        .step-responsible {
            font-size: clamp(0.8rem, 3vw, 0.9rem);
            color: var(--gray);
            margin-bottom: 0.8rem;
            width: 100%;
        }

        .step-description {
            font-size: clamp(0.85rem, 3vw, 0.95rem);
            margin-bottom: 1rem;
            color: var(--dark);
            word-break: break-word;
        }

        .transitions {
            margin-top: 1.2rem;
        }

        .transition {
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 0.8rem;
            font-size: clamp(0.8rem, 3vw, 0.9rem);
            position: relative;
            transition: var(--transition);
        }

        .transition-primary {
            background-color: rgba(46, 204, 113, 0.1);
            border-left: 4px solid var(--success);
        }

        .transition-correction {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--warning);
        }

        .transition-title {
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .transition-title i {
            margin-right: 0.4rem;
            flex-shrink: 0;
        }

        .transition-condition {
            font-size: clamp(0.75rem, 3vw, 0.85rem);
            color: var(--gray);
            word-break: break-word;
        }

        .connector {
            width: 2px;
            height: 1.5rem;
            background-color: var(--accent);
            position: relative;
            margin: 0 auto;
        }

        .connector:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--accent);
        }

        .parallel-steps {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            position: relative;
            width: 100%;
        }

        .edit-controls {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .step-actions {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.8rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: clamp(0.9rem, 3vw, 1rem);
            white-space: nowrap;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: var(--gray);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: clamp(0.8rem, 3vw, 0.9rem);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-content {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .modal-title {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            font-size: clamp(0.9rem, 3vw, 1rem);
        }

        .form-control {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: clamp(0.9rem, 3vw, 1rem);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem;
            margin-top: 1.2rem;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .password-content {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--card-shadow);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: var(--success);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 500px;
            margin: 0 auto;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background-color: var(--danger);
        }

        .toast i {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .parallel-steps {
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
            }
            
            .step {
                margin-bottom: 2rem;
            }

            .header {
                margin-bottom: 1.5rem;
                padding-bottom: 1.25rem;
            }

            .logo {
                height: 50px;
                margin-bottom: 0.75rem;
            }

            .toast {
                left: auto;
                max-width: none;
            }
        }

        @media (max-width: 576px) {
            .edit-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .btn {
                width: 100%;
                padding: 0.75rem;
            }

            .modal-content {
                padding: 1rem;
            }

            .form-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .form-actions .btn {
                width: 100%;
            }
        }

        /* Ajustes para telas muito pequenas */
        @media (max-width: 400px) {
            .step-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .step-icon {
                margin-bottom: 0.5rem;
                margin-right: 0;
            }

            .step-actions {
                justify-content: center;
            }

            .step-actions .btn {
                flex: 1;
                min-width: 100px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="https://ingressosweb.com.br/img/logo-dark.640276db.png" alt="Logo" class="logo">
            <h1>Fluxograma - Gest√£o de Eventos</h1>
            <p class="subtitle">Visualize e edite o fluxo completo do processo</p>
        </div>

        <!-- Edit Controls -->
        <div class="edit-controls" id="editControls">
            <button id="toggleEditBtn" class="btn btn-primary">
                <i class="fas fa-edit"></i> Editar Fluxograma
            </button>
            <button id="addStepBtn" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-plus"></i> Adicionar Passo
            </button>
            <button id="saveFlowBtn" class="btn btn-success" style="display: none;">
                <i class="fas fa-save"></i> Salvar no Projeto
            </button>
            <button id="exportJsonBtn" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-file-export"></i> Exportar JSON
            </button>
            <button id="importJsonBtn" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-file-import"></i> Importar JSON
            </button>
            <button id="resetFlowBtn" class="btn btn-danger" style="display: none;">
                <i class="fas fa-trash"></i> Resetar
            </button>
        </div>

        <!-- Flowchart -->
        <div class="flowchart" id="flowchart">
            <!-- Os passos ser√£o renderizados aqui dinamicamente -->
        </div>

        <!-- Step Modal -->
        <div class="modal" id="stepModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Adicionar Passo</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="stepName">Nome do Passo</label>
                    <input type="text" id="stepName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="stepIcon">√çcone (Font Awesome)</label>
                    <input type="text" id="stepIcon" class="form-control" placeholder="Ex: clipboard-check">
                </div>
                <div class="form-group">
                    <label for="stepDescription">Descri√ß√£o</label>
                    <textarea id="stepDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="stepResponsible">Respons√°vel</label>
                    <input type="text" id="stepResponsible" class="form-control">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancelStep">Cancelar</button>
                    <button class="btn btn-primary" id="saveStep">Salvar</button>
                </div>
            </div>
        </div>

        <!-- Transition Modal -->
        <div class="modal" id="transitionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="transitionModalTitle">Adicionar Transi√ß√£o</h3>
                    <button class="close-modal" id="closeTransitionModal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="transitionType">Tipo</label>
                    <select id="transitionType" class="form-control">
                        <option value="primary">Fluxo Principal (Aprovado)</option>
                        <option value="correction">Retorno (N√£o Aprovado)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transitionTarget">Destino</label>
                    <select id="transitionTarget" class="form-control">
                        <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="transitionDescription">Descri√ß√£o</label>
                    <input type="text" id="transitionDescription" class="form-control">
                </div>
                <div class="form-group">
                    <label for="transitionCondition">Condi√ß√£o</label>
                    <textarea id="transitionCondition" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancelTransition">Cancelar</button>
                    <button class="btn btn-primary" id="saveTransition">Salvar</button>
                </div>
            </div>
        </div>

        <!-- Password Modal -->
        <div class="password-modal" id="passwordModal">
            <div class="password-content">
                <h3 style="margin-bottom: 1rem;">Autentica√ß√£o Requerida</h3>
                <div class="form-group">
                    <label for="editPassword">Digite a senha para editar:</label>
                    <input type="password" id="editPassword" class="form-control" placeholder="Senha">
                </div>
                <div class="form-actions" style="justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" id="cancelPassword">Cancelar</button>
                    <button class="btn btn-primary" id="confirmPassword">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Opera√ß√£o realizada com sucesso!</span>
        </div>
    </div>

    <script>
        // Dados iniciais do fluxograma
        const DEFAULT_WORKFLOW = [
            {
                id: 'gestao-operacional',
                name: 'Gest√£o Operacional',
                icon: 'clipboard-check',
                description: 'An√°lise prim√°ria do evento com todas as informa√ß√µes necess√°rias e requisitos b√°sicos para dar prosseguimento ao planejamento do mesmo.',
                responsible: 'Aglaessio Reis',
                transitions: [
                    {
                        target: 'comercial',
                        description: 'Retorna para o Setor Comercial',
                        condition: 'Inconformidades no preenchimento da planilha do Evento ou necessidade de esclarecimentos',
                        type: 'correction'
                    },
                    {
                        target: 'compras',
                        description: 'Avan√ßa para os Setores de Compras, Estoque e Opera√ß√£o T√©cnica',
                        condition: 'Planilha analisada e atendendo todas as necessidades para dar continuidade aos respectivos processos',
                        type: 'primary'
                    }
                ]
            },
            {
                id: 'compras',
                name: 'Compras',
                icon: 'shopping-cart',
                description: 'Aquisi√ß√£o de materias, servi√ßos e equipamentos necess√°rios para o evento',
                responsible: '√Ä definir',
                transitions: [
                    {
                        target: 'gestao-operacional',
                        description: 'Retorna para o Gestor Operacional',
                        condition: 'Inconformidades, duvidas ou falta de informa√ß√µes necess√°rias para dar continuidade no processo',
                        type: 'correction'
                    },
                    {
                        target: 'operacao-tecnica',
                        description: 'Avan√ßa para Opera√ß√£o T√©cnica',
                        condition: 'Retorna o planejamento logistico para o Gestor Operacional buscar aprova√ß√µes, aprovando, o Setor de compras avan√ßa para a realiza√ß√£o dos procedimentos de reservas, compras e etc.',
                        type: 'primary'
                    }
                ]
            },
            {
                id: 'estoque',
                name: 'Estoque',
                icon: 'boxes',
                description: 'Armazenagem, prepara√ß√£o e envio de equipamentos necess√°rios (PDV\'s, totens, equipe t√©cnica e etc.)',
                responsible: 'Alessandro Vieira',
                transitions: [
                    {
                        target: 'comercial',
                        description: 'Retorna para o Gestor Comercial',
                        condition: 'Inconformidades nas solicita√ß√µes, falta de informa√ß√µes, ou qualquer necessidade que impossibilite o proceguimento dos processos',
                        type: 'correction'
                    },
                    {
                        target: 'compras',
                        description: 'Avan√ßa para Compras ou Finaliza processo',
                        condition: 'Se houver custos, avan√ßa para os Setores de Compras fazer or√ßamento e solicitar aprova√ß√£o do Gestor Operacional, aprovado, retorna para o Estoque dar continuidade e finalizar o processo. Se n√£o houver custos, o estoque sinaliza o Gestor Operacional e avan√ßa e finalizando o processo como envio de PDV\'s e outros processos.',
                        type: 'primary'
                    }
                ]
            },
            {
                id: 'operacao-tecnica',
                name: 'Opera√ß√£o T√©cnica',
                icon: 'tools',
                description: 'Execu√ß√£o do evento no local, montagem, configura√ß√£o dos equipamentos e suporte t√©cnico',
                responsible: 'Aglaessio Reis',
                transitions: [
                    {
                        target: 'compras',
                        description: 'Retorna para Compras',
                        condition: 'Inconformidades nos recursos disponibilizados ou qualquer situa√ß√£o que envolva o planejamento logistico',
                        type: 'correction'
                    },
                    {
                        target: 'estoque',
                        description: 'Retorna para Estoque',
                        condition: 'Inconformidades nos equipamentos e insumos para realiza√ß√£o do evento e seus respectivos processos',
                        type: 'correction'
                    },
                    {
                        target: 'gestao-operacional-pos',
                        description: 'Avan√ßa com a execu√ß√£o do evento e finaliza√ß√£o',
                        condition: 'A equipe t√©cnica ir√° dar continuidade no processo de execu√ß√£o e finaliza√ß√£o do evento. Ao finalizar, retorna o formul√°rio de p√≥s evento ao Gestor Operacional para dar proceguimento no encerramento do evento.',
                        type: 'primary'
                    }
                ]
            },
            {
                id: 'gestao-operacional-pos',
                name: 'Gest√£o Operacional (P√≥s-Evento)',
                icon: 'clipboard-check',
                description: 'An√°lise do formul√°rio de p√≥s-evento e encerramento do processo',
                responsible: 'Aglaessio Reis',
                transitions: [
                    {
                        target: 'operacao-tecnica',
                        description: 'Retorna para Opera√ß√£o T√©cnica',
                        condition: 'Inconformidades no preenchimento no formul√°rio p√≥s t√©cnico ou necessidade de esclarecimentos.',
                        type: 'correction'
                    },
                    {
                        target: 'estoque',
                        description: 'Avan√ßa para o Estoque',
                        condition: 'Aciona o Estoque para dar proseguimento no retorno dos PDV\'s, ao finalizar o recebimento dos equipamentos, sinaliza o Gestor Operacional para avan√ßar para o Financeiro dar continuidade ao processo',
                        type: 'primary'
                    }
                ]
            }
        ];

        // Configura√ß√µes
        const PASSWORD = "Maria.191290";
        const STORAGE_KEY = "event_workflow_data";
        const JSON_FILE_URL = "fluxograma.json";

        // Estado da aplica√ß√£o
        let editMode = false;
        let currentStepId = null;
        let currentTransitionIndex = null;
        let editingStep = null;
        let editingTransition = null;
        let workflowSteps = [];

        // Elementos do DOM
        const editControls = document.getElementById('editControls');
        const toggleEditBtn = document.getElementById('toggleEditBtn');
        const addStepBtn = document.getElementById('addStepBtn');
        const saveFlowBtn = document.getElementById('saveFlowBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const importJsonBtn = document.getElementById('importJsonBtn');
        const resetFlowBtn = document.getElementById('resetFlowBtn');
        const flowchart = document.getElementById('flowchart');
        const stepModal = document.getElementById('stepModal');
        const modalTitle = document.getElementById('modalTitle');
        const stepNameInput = document.getElementById('stepName');
        const stepIconInput = document.getElementById('stepIcon');
        const stepDescriptionInput = document.getElementById('stepDescription');
        const stepResponsibleInput = document.getElementById('stepResponsible');
        const saveStepBtn = document.getElementById('saveStep');
        const cancelStepBtn = document.getElementById('cancelStep');
        const closeModalBtn = document.getElementById('closeModal');
        const transitionModal = document.getElementById('transitionModal');
        const transitionTypeSelect = document.getElementById('transitionType');
        const transitionTargetSelect = document.getElementById('transitionTarget');
        const transitionDescriptionInput = document.getElementById('transitionDescription');
        const transitionConditionInput = document.getElementById('transitionCondition');
        const saveTransitionBtn = document.getElementById('saveTransition');
        const cancelTransitionBtn = document.getElementById('cancelTransition');
        const closeTransitionModalBtn = document.getElementById('closeTransitionModal');
        const passwordModal = document.getElementById('passwordModal');
        const editPasswordInput = document.getElementById('editPassword');
        const confirmPasswordBtn = document.getElementById('confirmPassword');
        const cancelPasswordBtn = document.getElementById('cancelPassword');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        // Fun√ß√µes de carregamento/salvamento
        async function loadWorkflow() {
            try {
                // Tenta carregar do localStorage primeiro
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        return parsedData;
                    }
                }

                // Se n√£o tiver no localStorage ou for inv√°lido, tenta carregar do arquivo
                const response = await fetch(`${JSON_FILE_URL}?t=${new Date().getTime()}`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Valida a estrutura dos dados
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Estrutura de dados inv√°lida no arquivo');
                }
                
                // Salva no localStorage para uso futuro
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                return data;
                
            } catch (error) {
                console.warn('Erro ao carregar workflow:', error.message);
                // Retorna os dados padr√£o em caso de erro
                return [...DEFAULT_WORKFLOW];
            }
        }

        async function saveToProject() {
            try {
                // Criar um novo Blob com o conte√∫do atualizado
                const workflowData = JSON.stringify(workflowSteps, null, 2);
                const blob = new Blob([workflowData], { type: 'application/json' });
                
                // Criar um link para download do arquivo atualizado
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'fluxograma.json';
                
                // Disparar o download
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Arquivo pronto para ser commitado no projeto!');
                
            } catch (error) {
                console.error('Erro ao salvar no projeto:', error);
                showToast('Erro ao salvar no projeto: ' + error.message, 'error');
            }
        }

        function saveWorkflow() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(workflowSteps));
            saveToProject();
            showToast('Altera√ß√µes salvas localmente e no projeto');
        }

        async function loadFromRepo() {
            try {
                const response = await fetch(`${JSON_FILE_URL}?t=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Valida√ß√£o dos dados
                if (!Array.isArray(data)) {
                    throw new Error('Dados inv√°lidos - n√£o √© um array');
                }
                
                if (data.length === 0) {
                    throw new Error('Arquivo est√° vazio');
                }
                
                workflowSteps = data;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                renderFlowchart();
                showToast('Dados carregados do arquivo com sucesso!');
                return true;
                
            } catch (error) {
                console.error('Falha ao carregar do arquivo:', error);
                showToast(`Erro: ${error.message}`, 'error');
                return false;
            }
        }

        function exportToJson() {
            const dataStr = JSON.stringify(workflowSteps, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fluxograma-exportado.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('JSON exportado com sucesso!');
        }

        function importFromJson() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Valida√ß√£o b√°sica dos dados
                        if (!Array.isArray(data)) {
                            throw new Error('Arquivo inv√°lido - deve conter um array');
                        }
                        
                        workflowSteps = data;
                        saveWorkflow();
                        renderFlowchart();
                        showToast('JSON importado com sucesso!');
                    } catch (error) {
                        console.error('Erro ao importar:', error);
                        showToast('Erro ao importar JSON: ' + error.message, 'error');
                    }
                };
                reader.onerror = () => {
                    showToast('Erro ao ler o arquivo', 'error');
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Fun√ß√µes principais
        function renderFlowchart() {
            flowchart.innerHTML = '';
            
            workflowSteps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = `step ${editMode ? 'editable' : ''}`;
                stepElement.dataset.id = step.id;
                
                let iconClass = step.icon.startsWith('fa-') ? step.icon : `fa-${step.icon}`;
                
                stepElement.innerHTML = `
                    <div class="step-header">
                        <div class="step-icon">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <h3 class="step-title">${step.name}</h3>
                    </div>
                    <div class="step-responsible">Respons√°vel: ${step.responsible}</div>
                    <div class="step-description">${step.description}</div>
                    
                    <div class="transitions">
                        ${step.transitions.map((transition, idx) => `
                            <div class="transition transition-${transition.type}">
                                <div class="transition-title">
                                    <i class="fas fa-arrow-${transition.type === 'primary' ? 'right' : 'left'}"></i> 
                                    ${transition.description}
                                </div>
                                <div class="transition-condition">${transition.condition}</div>
                                ${editMode ? `
                                    <div class="step-actions">
                                        <button class="btn btn-sm btn-secondary edit-transition" data-index="${idx}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-transition" data-index="${idx}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    ${editMode ? `
                        <div class="step-actions">
                            <button class="btn btn-sm btn-secondary edit-step">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-danger delete-step">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                            <button class="btn btn-sm btn-primary add-transition">
                                <i class="fas fa-plus"></i> Transi√ß√£o
                            </button>
                        </div>
                    ` : ''}
                `;
                
                flowchart.appendChild(stepElement);
                
                if (index < workflowSteps.length - 1) {
                    const connector = document.createElement('div');
                    connector.className = 'connector';
                    flowchart.appendChild(connector);
                }
                
                if (editMode) {
                    const editStepBtn = stepElement.querySelector('.edit-step');
                    const deleteStepBtn = stepElement.querySelector('.delete-step');
                    const addTransitionBtn = stepElement.querySelector('.add-transition');
                    const editTransitionBtns = stepElement.querySelectorAll('.edit-transition');
                    const deleteTransitionBtns = stepElement.querySelectorAll('.delete-transition');
                    
                    editStepBtn.addEventListener('click', () => {
                        editingStep = workflowSteps.find(s => s.id === step.id);
                        modalTitle.textContent = 'Editar Passo';
                        stepNameInput.value = editingStep.name;
                        stepIconInput.value = editingStep.icon;
                        stepDescriptionInput.value = editingStep.description;
                        stepResponsibleInput.value = editingStep.responsible;
                        stepModal.style.display = 'flex';
                    });
                    
                    deleteStepBtn.addEventListener('click', () => {
                        if (confirm(`Tem certeza que deseja excluir o passo "${step.name}"?`)) {
                            workflowSteps = workflowSteps.filter(s => s.id !== step.id);
                            saveWorkflow();
                            renderFlowchart();
                            showToast(`Passo "${step.name}" exclu√≠do`);
                        }
                    });
                    
                    addTransitionBtn.addEventListener('click', () => {
                        currentStepId = step.id;
                        editingTransition = null;
                        document.getElementById('transitionModalTitle').textContent = 'Adicionar Transi√ß√£o';
                        transitionTypeSelect.value = 'primary';
                        transitionDescriptionInput.value = '';
                        transitionConditionInput.value = '';
                        
                        transitionTargetSelect.innerHTML = '';
                        workflowSteps.forEach(s => {
                            if (s.id !== step.id) {
                                const option = document.createElement('option');
                                option.value = s.id;
                                option.textContent = s.name;
                                transitionTargetSelect.appendChild(option);
                            }
                        });
                        
                        transitionModal.style.display = 'flex';
                    });
                    
                    editTransitionBtns.forEach((btn, idx) => {
                        btn.addEventListener('click', () => {
                            currentStepId = step.id;
                            currentTransitionIndex = idx;
                            editingTransition = step.transitions[idx];
                            
                            document.getElementById('transitionModalTitle').textContent = 'Editar Transi√ß√£o';
                            transitionTypeSelect.value = editingTransition.type;
                            transitionDescriptionInput.value = editingTransition.description;
                            transitionConditionInput.value = editingTransition.condition;
                            
                            transitionTargetSelect.innerHTML = '';
                            workflowSteps.forEach(s => {
                                const option = document.createElement('option');
                                option.value = s.id;
                                option.textContent = s.name;
                                if (s.id === editingTransition.target) {
                                    option.selected = true;
                                }
                                transitionTargetSelect.appendChild(option);
                            });
                            
                            transitionModal.style.display = 'flex';
                        });
                    });
                    
                    deleteTransitionBtns.forEach((btn, idx) => {
                        btn.addEventListener('click', () => {
                            if (confirm('Tem certeza que deseja excluir esta transi√ß√£o?')) {
                                step.transitions.splice(idx, 1);
                                saveWorkflow();
                                renderFlowchart();
                                showToast('Transi√ß√£o exclu√≠da');
                            }
                        });
                    });
                }
            });
        }

        function updateEditModeUI() {
            toggleEditBtn.innerHTML = `<i class="fas ${editMode ? 'fa-eye' : 'fa-edit'}"></i> ${editMode ? 'Visualizar' : 'Editar'} Fluxograma`;
            addStepBtn.style.display = editMode ? 'flex' : 'none';
            saveFlowBtn.style.display = editMode ? 'flex' : 'none';
            exportJsonBtn.style.display = editMode ? 'flex' : 'none';
            importJsonBtn.style.display = editMode ? 'flex' : 'none';
            resetFlowBtn.style.display = editMode ? 'flex' : 'none';
        }

        function showToast(message, type = 'success') {
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            
            const icon = toast.querySelector('i');
            icon.className = type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Event Listeners
        toggleEditBtn.addEventListener('click', () => {
            if (!editMode) {
                passwordModal.style.display = 'flex';
                editPasswordInput.focus();
            } else {
                editMode = false;
                updateEditModeUI();
                renderFlowchart();
                showToast('Modo visualiza√ß√£o ativado');
            }
        });

        confirmPasswordBtn.addEventListener('click', () => {
            if (editPasswordInput.value === PASSWORD) {
                passwordModal.style.display = 'none';
                editPasswordInput.value = '';
                editMode = true;
                updateEditModeUI();
                renderFlowchart();
                showToast('Modo edi√ß√£o ativado');
            } else {
                showToast('Senha incorreta', 'error');
                editPasswordInput.focus();
            }
        });

        cancelPasswordBtn.addEventListener('click', () => {
            passwordModal.style.display = 'none';
            editPasswordInput.value = '';
        });

        addStepBtn.addEventListener('click', () => {
            if (!editMode) return;
            
            editingStep = null;
            modalTitle.textContent = 'Adicionar Passo';
            stepNameInput.value = '';
            stepIconInput.value = '';
            stepDescriptionInput.value = '';
            stepResponsibleInput.value = '';
            stepModal.style.display = 'flex';
            stepNameInput.focus();
        });

        saveFlowBtn.addEventListener('click', () => {
            if (!editMode) return;
            saveWorkflow();
            
            saveFlowBtn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
            setTimeout(() => {
                saveFlowBtn.innerHTML = '<i class="fas fa-save"></i> Salvar no Projeto';
            }, 2000);
        });

        resetFlowBtn.addEventListener('click', () => {
            if (!editMode) return;
            
            if (confirm('Tem certeza que deseja resetar o fluxograma para o estado original? Todas as altera√ß√µes ser√£o perdidas.')) {
                workflowSteps = [...DEFAULT_WORKFLOW];
                saveWorkflow();
                renderFlowchart();
                showToast('Fluxograma resetado para o estado original');
            }
        });

        saveStepBtn.addEventListener('click', () => {
            const name = stepNameInput.value.trim();
            let icon = stepIconInput.value.trim();
            const description = stepDescriptionInput.value.trim();
            const responsible = stepResponsibleInput.value.trim();
            
            if (!name || !icon || !description || !responsible) {
                showToast('Preencha todos os campos', 'error');
                return;
            }
            
            if (!icon.startsWith('fa-')) {
                icon = icon;
            }
            
            if (editingStep) {
                editingStep.name = name;
                editingStep.icon = icon;
                editingStep.description = description;
                editingStep.responsible = responsible;
                showToast(`Passo "${name}" atualizado`);
            } else {
                const newStep = {
                    id: name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''),
                    name,
                    icon,
                    description,
                    responsible,
                    transitions: []
                };
                workflowSteps.push(newStep);
                showToast(`Passo "${name}" adicionado`);
            }
            
            stepModal.style.display = 'none';
            saveWorkflow();
            renderFlowchart();
        });

        saveTransitionBtn.addEventListener('click', () => {
            const type = transitionTypeSelect.value;
            const target = transitionTargetSelect.value;
            const description = transitionDescriptionInput.value.trim();
            const condition = transitionConditionInput.value.trim();
            
            if (!target || !description) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            const step = workflowSteps.find(s => s.id === currentStepId);
            const targetStep = workflowSteps.find(s => s.id === target);
            
            if (!step || !targetStep) {
                showToast('Passo n√£o encontrado', 'error');
                return;
            }
            
            const newTransition = {
                target,
                description,
                condition,
                type
            };
            
            if (editingTransition) {
                step.transitions[currentTransitionIndex] = newTransition;
                showToast('Transi√ß√£o atualizada');
            } else {
                step.transitions.push(newTransition);
                showToast(`Nova transi√ß√£o para "${targetStep.name}" adicionada`);
            }
            
            transitionModal.style.display = 'none';
            saveWorkflow();
            renderFlowchart();
        });

        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                workflowSteps = await loadWorkflow();
                renderFlowchart();
                
                // Verifica se deve carregar do reposit√≥rio
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('load')) {
                    await loadFromRepo();
                }
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                workflowSteps = [...DEFAULT_WORKFLOW];
                renderFlowchart();
                showToast('Erro ao carregar dados, usando padr√£o', 'error');
            }
        });

        // Event listeners para fechar modais
        cancelStepBtn.addEventListener('click', () => stepModal.style.display = 'none');
        closeModalBtn.addEventListener('click', () => stepModal.style.display = 'none');
        cancelTransitionBtn.addEventListener('click', () => transitionModal.style.display = 'none');
        closeTransitionModalBtn.addEventListener('click', () => transitionModal.style.display = 'none');

        window.addEventListener('click', (e) => {
            if (e.target === stepModal) stepModal.style.display = 'none';
            if (e.target === transitionModal) transitionModal.style.display = 'none';
            if (e.target === passwordModal) passwordModal.style.display = 'none';
        });

        editPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') confirmPasswordBtn.click();
        });

        // Bot√µes de importa√ß√£o/exporta√ß√£o
        exportJsonBtn.addEventListener('click', exportToJson);
        importJsonBtn.addEventListener('click', importFromJson);
    </script>
</body>
</html>
